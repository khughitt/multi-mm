### Covariate similarity

```{r}
covariate_dat <- gene_weights %>%
  select(-gene_symbol, -ensgene, 
         -matches('_mean$'), -matches('_median$'), -matches('_sd$'),
         -matches('_mad$'), -matches('_kurtosis$'),
         -matches('_dip_stat$'), -matches('_pval$'))

# use PFS > OS covariates (more informative)
covariate_dat <- covariate_dat[, !grepl('os_cox', colnames(covariate_dat))]

# for GSE24080, drop 'patient_died' field (similar to pfs_event)
covariate_dat <- covariate_dat %>%
  select(-GSE24080_patient_died)

# number of missing entries for each gene
gene_num_na <- apply(covariate_dat, 1, function(x) { sum(is.na(x)) })

#table(gene_num_na)
# gene_num_na
#     0     1     2     3     4     5     6     7     8     9    10    11    12    13    14    15 
#  5465   206   176  6250   571   672  2676   369   810   834   910   526   335  1604    38   168 
#    16    17    18    19    20    21    22    23    24    25    26    27    28 
#   106  1192    52     8    93   578   442   954 19075  1702 14054   977   632 

max_na <- ceiling(GENE_MAX_MISSING_COVARIATES * ncol(covariate_dat))
mask <- gene_num_na <= max_na

#table(mask)
# mask
# FALSE  TRUE 
# 41118 20357 
covariate_dat <- covariate_dat[mask, ]

# convert p-values to -log10(pvalue) scores so that directionality is the same for
# all variables
#covariate_dat <- covariate_dat %>%
#  mutate_at(vars(matches("_pval_?\\d*$")), function (x) { -log10(x) }) %>%
#  mutate_each(list(scale))

# max-scale and shift to [0, 1]
max_scale <- function(x) {
  x <- x - min(x, na.rm = TRUE)
  x / max(x, na.rm = TRUE)
}
covariate_dat <- sapply(covariate_dat, max_scale)
rownames(covariate_dat) <- gene_weights$gene_symbol[mask]

# how much each column contributes to the score..
#range(colSums(covariate_dat, na.rm = TRUE))
# [1]  335 4751

# normalize across columns so that each covariate contributes equally
covariate_dat <- sweep(covariate_dat, 2, colSums(covariate_dat, na.rm = TRUE), '/') * 1E6

# covariate types
covariate_fields <- data.frame(
  contains = c('response', 'stage|status|ecog', 'subgroup', '_pfs_|_os_|_died'),
  type     = c('Treatment Response', 'Disease Stage', 'Patient Subgroup', 'Survival')               
)

covariate_types <- rep('', ncol(covariate_dat))

for (i in 1:nrow(covariate_fields)) {
  covariate_types[grepl(covariate_fields$contains[i], 
                        colnames(covariate_dat))] <- covariate_fields$type[i]
}

covariate_cor_mat <- round(cor(covariate_dat, use = 'pairwise.complete.obs'), 2)

# set diagonal or correlation matrix to 0 to improve contrast
diag(covariate_cor_mat) <- 0

heatmaply(covariate_cor_mat, draw_cellnote = TRUE, cellnote_size = 8,
          row_side_colors = data.frame(Covariate=covariate_types))

# static version

# human-readable row labels
row_labels <- rownames(covariate_cor_mat)

acc <- str_split(row_labels, '_', simplify = TRUE)[, 1]
authors <- datasets$dataset[match(acc, datasets$accession)]

gse_ind <- grepl('GSE', row_labels)
authors[!gse_ind] <- 'MMRF CoMMpass'

phenotypes <- rep("Treatment", length(row_labels))
phenotypes[grepl('iss', row_labels)] <- 'ISS Stage'
phenotypes[grepl('pfs', row_labels)] <- 'PFS'
phenotypes[grepl('mm_stage', row_labels)] <- 'MM Stage'
phenotypes[grepl('mm_status', row_labels)] <- 'MM Status'
phenotypes[grepl('died', row_labels)] <- 'Deceased'
phenotypes[grepl('subgroup', row_labels)] <- 'Subgroup'
phenotypes[grepl('ecog', row_labels)] <- 'ECOG Status'

phenotypes[grepl('Bor_Cyc', row_labels)] <- 'Bor/Cyc/Dex'
phenotypes[grepl('Bor_Len', row_labels)] <- 'Bor/Len/Dex'
phenotypes[grepl('Bor_Dex', row_labels)] <- 'Bor/Dex'
phenotypes[grepl('Car_Cyc', row_labels)] <- 'Car/Cyc/Dex'

row_labels <- paste0(authors, ' / ', phenotypes)

png('MM_14_datasets_heatmap_2019-06-24.png', width = 1920, height = 1080, res = 192)
aheatmap(covariate_cor_mat, color = viridis(100), Colv = FALSE, labCol = '',
         labRow = row_labels,
         annRow = data.frame(Phenotype=covariate_types), annColors = 'Dark2')
dev.off()
```
